<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script type="text/javascript" src="js/bundle.js" charset="utf-8"></script>

    <!-- <script type="text/javascript" src="/node_modules/leaflet/dist/leaflet.js"></script> -->
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />

    <script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.3.0"></script>

    <style>
      #map {
        height: 100%;
        width: 80%;
      }

      #guide {
        float: right;
        width: 20%;
        height: 100%;
        background: url("/assets/china-pattern-design.jpg") repeat-x;
      }

      #info {
        padding: 5%;
      }

      #tour_list {
        font-weight: bold;
      }

      body {
        font-family: Helvetica, sans-serif;
      }
    </style>
</head>

<body>

<div id="guide">

  <div id="info">
    <h1>China 2016</h1>
    <div id="tour_list"></div>
  </div>

</div>

<div id="map"></div>

<script>

  var photo_list = {{{photo_tour_json}}};

  console.log(photo_list);

  // Define list of photos, comprised of multiple "tours"
  /*
  var photo_list = [
    {
      tour_id: "llama",
      tour_name: "Llama & Confucius Temples",
      color: "yellow",
      photos: [
        {filename: "R0010012.JPG", lat: 39.9457, long: 116.4112},
        {filename: "R0010024.JPG", lat: 39.9455, long: 116.4083},
        {filename: "R0010029.JPG", lat: 39.9445, long: 116.4082}
      ]
    },
    {
      tour_id: "wanderings",
      tour_name: "Wanderings",
      color: "black",
      photos: [
        {filename: "R0010031.JPG", lat: 39.9472, long: 116.4096},
        {filename: "R0010033.JPG", lat: 39.9077, long: 116.4241}
      ]
    },
    {
      tour_id: "forbidden",
      tour_name: "Forbidden City",
      color: "red",
      photos: [
        {filename: "R0010040.JPG", lat: 39.9066, long: 116.3917},
        {filename: "R0010042.JPG", lat: 39.9083, long: 116.3912},
        {filename: "R0010044.JPG", lat: 39.9133, long: 116.392},
        {filename: "R0010046.JPG", lat: 39.9141, long: 116.391},
        {filename: "R0010048.JPG", lat: 39.9144, long: 116.391},
        {filename: "R0010050.JPG", lat: 39.9162, long: 116.3904},
        {filename: "R0010052.JPG", lat: 39.9177, long: 116.3874},
        {filename: "R0010055.JPG", lat: 39.9201, long: 116.39},
        {filename: "R0010058.JPG", lat: 39.9234, long: 116.3905}
      ]
    },
    {
      tour_id: "wall",
      tour_name: "Great Wall",
      color: "green",
      photos: [
        {filename: "R0010060.JPG", lat: 40.6766, long: 117.2328},
        {filename: "R0010062.JPG", lat: 40.6764, long: 117.2332},
        {filename: "R0010065.JPG", lat: 40.6762, long: 117.2345},
        {filename: "R0010068.JPG", lat: 40.6753, long: 117.2364},
        {filename: "R0010070.JPG", lat: 40.6766, long: 117.2415}
      ]
    }
    // Stopped at 77
  ];
  */

  // Initialize Leaflet map

  var map = new L.map('map', {
    center: new L.LatLng(39.9457, 116.4112),
    zoom: 10,
    maxZoom: 17
  });


  // Baselayer

  var baselayer = new L.StamenTileLayer("toner");

  baselayer.addTo(map);


  // Layers Control

  var baseMaps = {
    "Stamen Toner": baselayer
  };

  var overlayMaps = {};


  // Iterate over each tour, adding photos to a separate "photoLayer" layer group
  // then add to map

  photo_list.forEach(function(tour) {
    console.log("Loading tour: " + tour.tour_name);

    var photoLayer = new L.featureGroup();

    tour.photos.forEach(function(photo){
      var marker = L.circle([photo.lat, photo.long], 50, {
        color: tour.color,
        fillColor: tour.color,
        fillOpacity: 0.5
      }).addEventListener("click", showPhotosphere);

      marker.filename = photo.filename;
      marker.addTo(photoLayer);
    });

    overlayMaps[tour.tour_id] = photoLayer;
    console.log(overlayMaps);

    photoLayer.addTo(map);

    // Zoom to a specific tour

    function zoomToTour(e) {
      console.log(e);
      map.fitBounds(photoLayer.getBounds());
    }

    // Add tour to tour list in the map guide
    var tour_list_item = document.createElement('h2');
    tour_list_item.appendChild(document.createTextNode(tour.tour_name));
    tour_list_item.style.color = tour.color;
    tour_list_item.addEventListener("click", zoomToTour);

    document.getElementById('tour_list').appendChild(tour_list_item);
  });


  // Layer Controls

  L.control.layers(baseMaps, overlayMaps).addTo(map);


  // Hide and show photosphere

  function showPhotosphere(e) {
    console.log(e);
    location.assign('/photosphere/' + e.target.filename);
  }


</script>


</body>
</html>
